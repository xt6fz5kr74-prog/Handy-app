<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Lager App">
<title>Lager & Angebot</title>
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;margin:0;padding:0;background:#f0f2f5;overflow-x:hidden;}
.container{max-width:100%;margin:0;background:white;min-height:100vh;padding:15px;padding-bottom:80px;}
.header{position:sticky;top:0;background:white;z-index:100;padding:15px 0;border-bottom:2px solid #4CAF50;margin:0 -15px 15px -15px;padding-left:15px;padding-right:15px;}
h1{color:#333;margin:0;font-size:20px;display:flex;justify-content:space-between;align-items:center;}
.header-btns{display:flex;gap:5px;}
.header-btns button{padding:8px 12px;font-size:12px;}
.search-box{margin-bottom:15px;padding:12px;background:#e3f2fd;border-radius:8px;border-left:4px solid #2196F3;}
.search-box input{width:100%;padding:14px;font-size:16px;border:2px solid #2196F3;border-radius:6px;}
.search-box input:focus{outline:none;border-color:#1976d2;}
.form-section{margin-bottom:15px;}
.form-group{margin-bottom:12px;}
.form-group label{display:block;margin-bottom:5px;font-weight:600;color:#333;font-size:14px;}
input,select{width:100%;padding:14px;border:2px solid #ddd;border-radius:6px;font-size:16px;}
input:focus{outline:none;border-color:#4CAF50;}
input[readonly]{background:#e8f5e9;font-weight:bold;color:#2e7d32;}
.buttons{display:flex;flex-direction:column;gap:10px;margin-bottom:20px;}
button{padding:14px 20px;border:none;border-radius:6px;font-size:16px;cursor:pointer;color:white;font-weight:600;width:100%;touch-action:manipulation;}
button:active{transform:scale(0.98);}
.btn-add{background:#4CAF50;} .btn-add:active{background:#45a049;}
.btn-delete{background:#f44336;} .btn-delete:active{background:#da190b;}
.btn-print{background:#2196F3;} .btn-print:active{background:#0b7dda;}
.btn-export{background:#FF9800;} .btn-export:active{background:#e68900;}
.btn-offer{background:#9C27B0;} .btn-offer:active{background:#7B1FA2;}
.btn-small{padding:10px 14px;font-size:14px;margin:5px 0;width:100%;}
.card{background:white;border-radius:8px;padding:15px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,0.1);border-left:4px solid #4CAF50;}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;}
.card-number{font-size:14px;color:#666;font-weight:600;}
.card-title{font-size:18px;font-weight:bold;color:#333;margin:5px 0;}
.card-image{width:100%;height:200px;object-fit:cover;border-radius:6px;margin:10px 0;cursor:pointer;}
.card-details{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:10px 0;}
.detail-box{text-align:center;padding:10px;background:#f5f5f5;border-radius:6px;}
.detail-label{font-size:12px;color:#666;margin-bottom:3px;}
.detail-value{font-size:18px;font-weight:bold;color:#2e7d32;}
.card-actions{display:flex;gap:8px;margin-top:10px;}
.card-actions button{width:50%;}
.status{padding:12px;border-radius:6px;margin:10px 0;font-weight:600;text-align:center;}
.success{background:#d4edda;color:#155724;}
.empty{text-align:center;color:#999;padding:40px;font-style:italic;}
.modal{display:none;position:fixed;z-index:9999;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,0.8);}
.modal-content{background:#fff;margin:20px;padding:20px;border-radius:12px;max-height:90vh;overflow-y:auto;}
.close{cursor:pointer;font-size:32px;font-weight:bold;float:right;line-height:20px;color:#666;}
.close:active{color:#000;}
.preview-table{width:100%;border-collapse:collapse;margin:15px 0;font-size:14px;}
.preview-table th,.preview-table td{padding:10px;border:1px solid #ddd;text-align:left;}
.preview-table th{background:#4CAF50;color:white;}
.preview-img{width:60px;height:60px;object-fit:cover;border-radius:4px;}
.fab{position:fixed;bottom:20px;right:20px;width:60px;height:60px;border-radius:50%;background:#4CAF50;color:white;font-size:28px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1000;}
@media print{.no-print{display:none !important;}}
</style>
</head>
<body>
<div class="container">
<div class="header no-print">
<h1>üì¶ Lager App
  <div class="header-btns">
    <button id="btnSave" class="btn-export">üíæ</button>
    <button id="btnBackup" class="btn-export">üìã</button>
    <input type="file" id="fileImport" style="display:none">
    <button id="btnImport" class="btn-export">üìÇ</button>
  </div>
</h1>
</div>

<div class="search-box no-print">
<input type="text" id="searchInput" placeholder="üîç Suche nach Artikel oder Nummer..." />
</div>

<div id="status" class="no-print"></div>

<div class="form-section no-print">
<div class="form-group">
<label>Artikelname</label>
<input type="text" id="inp_artikel" placeholder="z.B. Laptop" />
</div>
<div class="form-group">
<label>Anzahl Kartons</label>
<input type="number" id="inp_kartons" placeholder="0" min="0" />
</div>
<div class="form-group">
<label>St√ºck/Karton</label>
<input type="number" id="inp_stueck" placeholder="0" min="0" />
</div>
<div class="form-group">
<label>Gesamt (automatisch)</label>
<input type="number" id="inp_gesamt" placeholder="0" readonly />
</div>
<div class="form-group">
<label>Anzahl Paletten</label>
<input type="number" id="inp_multiples" placeholder="1" min="1" value="1" />
</div>
</div>

<div class="buttons no-print">
<button class="btn-add" id="btnAdd">‚ûï Hinzuf√ºgen</button>
<button class="btn-print" id="btnInventory">üìã Bestandsliste PDF</button>
<button class="btn-offer" id="btnOffer">üìÑ Angebot erstellen</button>
<button class="btn-delete" id="btnClear">üóëÔ∏è Alle l√∂schen</button>
</div>

<div id="cardContainer"></div>
</div>

<input type="file" id="rowImageInput" accept="image/*" capture="environment" style="display:none">

<!-- Vorschau Modal -->
<div class="modal" id="previewModal">
  <div class="modal-content">
    <span class="close" id="previewClose">&times;</span>
    <div id="previewBody"></div>
    <div style="margin-top:15px;">
      <button id="downloadPreviewPdf" class="btn-print">PDF herunterladen</button>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div class="modal" id="imageModal">
  <div class="modal-content">
    <span class="close" id="imageClose">&times;</span>
    <img id="modalImg" src="" style="width:100%;border-radius:8px;">
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>
<script>
let data=[];
const cardContainer=document.getElementById('cardContainer');
const status=document.getElementById('status');
const previewModal=document.getElementById('previewModal');
const previewBody=document.getElementById('previewBody');
const downloadPreviewPdf=document.getElementById('downloadPreviewPdf');
const previewClose=document.getElementById('previewClose');
const imageModal=document.getElementById('imageModal');
const modalImg=document.getElementById('modalImg');
const imageClose=document.getElementById('imageClose');
const rowImageInput=document.getElementById('rowImageInput');

function esc(str){const d=document.createElement('div'); d.textContent=str; return d.innerHTML;}
function msg(text){status.innerHTML='<div class="status success">'+text+'</div>'; setTimeout(()=>{status.innerHTML='';},3000);}
function genBarcode(){return Math.floor(10000+Math.random()*90000).toString();}
function calc(){document.getElementById('inp_gesamt').value=(parseFloat(document.getElementById('inp_kartons').value)||0)*(parseFloat(document.getElementById('inp_stueck').value)||0);}
document.getElementById('inp_kartons').addEventListener('input',calc);
document.getElementById('inp_stueck').addEventListener('input',calc);

// --- HINZUF√úGEN ---
document.getElementById('btnAdd').addEventListener('click',()=>{
  let artikel=document.getElementById('inp_artikel').value.trim();
  if(!artikel){alert('Bitte Artikelname eingeben!'); return;}
  artikel=artikel.charAt(0).toUpperCase()+artikel.slice(1);
  const kartons=parseFloat(document.getElementById('inp_kartons').value)||0;
  const stueck=parseFloat(document.getElementById('inp_stueck').value)||0;
  const gesamt=kartons*stueck;
  const multiples=parseInt(document.getElementById('inp_multiples').value)||1;
  for(let j=0;j<multiples;j++){
    const barcode=genBarcode();
    data.push({artikel,kartons,stueck,gesamt,barcode,multiples,index:j,image:null});
  }
  render();
  saveData();
  document.getElementById('inp_artikel').value='';
  document.getElementById('inp_kartons').value='';
  document.getElementById('inp_stueck').value='';
  document.getElementById('inp_gesamt').value='';
  document.getElementById('inp_multiples').value=1;
  msg('‚úÖ '+multiples+' Eintr√§ge hinzugef√ºgt!');
  window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
});

// --- RENDER CARDS ---
function render(filter=''){
  if(!data.length){cardContainer.innerHTML='<div class="empty">Keine Eintr√§ge vorhanden</div>'; return;}
  let html=''; 
  data.forEach((d,i)=>{
    if(filter&&!Object.values(d).some(v=>v.toString().toLowerCase().includes(filter.toLowerCase()))) return;
    html+='<div class="card">';
    html+='<div class="card-header">';
    html+='<div><div class="card-number">Nr. '+esc(d.barcode)+'</div><div class="card-title">'+esc(d.artikel)+'</div></div>';
    html+='</div>';
    if(d.image){
      html+='<img src="'+d.image+'" class="card-image" onclick="showImage(\''+d.image+'\')">';
    }else{
      html+='<button class="btn-print btn-small" onclick="addImage('+i+')">üì∑ Bild hinzuf√ºgen</button>';
    }
    html+='<div class="card-details">';
    html+='<div class="detail-box"><div class="detail-label">Kartons</div><div class="detail-value">'+d.kartons+'</div></div>';
    html+='<div class="detail-box"><div class="detail-label">Stk/Karton</div><div class="detail-value">'+d.stueck+'</div></div>';
    html+='<div class="detail-box"><div class="detail-label">Gesamt</div><div class="detail-value">'+d.gesamt+'</div></div>';
    html+='</div>';
    html+='<div class="card-actions">';
    html+='<button class="btn-add btn-small" onclick="editItem('+i+')">‚úèÔ∏è Bearbeiten</button>';
    html+='<button class="btn-delete btn-small" onclick="del('+i+')">üóëÔ∏è L√∂schen</button>';
    html+='</div>';
    html+='</div>';
  });
  cardContainer.innerHTML=html;
}

// --- BILDER ---
function addImage(i){
  rowImageInput.onchange=(e)=>{
    const file=e.target.files[0]; 
    if(!file) return; 
    const reader=new FileReader(); 
    reader.onload=(evt)=>{
      const imgData=evt.target.result; 
      const multiples=data[i].multiples||1; 
      for(let j=0;j<multiples;j++){
        if(!data[i+j]) continue; 
        data[i+j].image=imgData;
      } 
      render(); 
      saveData(); 
      msg('‚úÖ Bild hinzugef√ºgt'); 
      rowImageInput.value='';
    }; 
    reader.readAsDataURL(file);
  }; 
  rowImageInput.click();
}

function showImage(src){modalImg.src=src; imageModal.style.display='block';}
imageClose.onclick=()=>{imageModal.style.display='none';}
previewClose.onclick=()=>{previewModal.style.display='none';}

// --- EDIT ---
function editItem(i){
  const d=data[i];
  let a=prompt('Artikelname:',d.artikel); if(!a) return; a=a.charAt(0).toUpperCase()+a.slice(1);
  let k=parseFloat(prompt('Kartons:',d.kartons)); if(isNaN(k)) k=d.kartons;
  let s=parseFloat(prompt('St√ºck/Karton:',d.stueck)); if(isNaN(s)) s=d.stueck;
  d.artikel=a; d.kartons=k; d.stueck=s; d.gesamt=k*s;
  render(); saveData(); msg('‚úÖ Eintrag bearbeitet');
}

// --- DELETE ---
function del(i){if(confirm('Wirklich l√∂schen?')){data.splice(i,1); render(); saveData(); msg('üóëÔ∏è Eintrag gel√∂scht');}}

// --- SEARCH ---
document.getElementById('searchInput').addEventListener('input',function(){render(this.value.trim());});

// --- CLEAR ALL ---
document.getElementById('btnClear').addEventListener('click',()=>{if(confirm('ALLE Eintr√§ge l√∂schen?')){data=[]; render(); saveData(); msg('üóëÔ∏è Alle gel√∂scht');}});

// --- SAVE/LOAD ---
function saveData(){localStorage.setItem('palettenData',JSON.stringify(data)); msg('‚úÖ Gespeichert');}
document.getElementById('btnSave').addEventListener('click',saveData);
window.addEventListener('load',()=>{ const saved=localStorage.getItem('palettenData'); if(saved){data=JSON.parse(saved); render();}});

// --- BACKUP ---
document.getElementById('btnBackup').addEventListener('click',()=>{if(!data.length){alert('Keine Eintr√§ge vorhanden!'); return;} const blob=new Blob([JSON.stringify(data)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download="paletten_backup.json"; a.click(); URL.revokeObjectURL(url); msg('‚úÖ Backup erstellt!');});

// --- IMPORT ---
document.getElementById('btnImport').addEventListener('click',()=>{document.getElementById('fileImport').click();});
document.getElementById('fileImport').addEventListener('change',(e)=>{const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=function(evt){try{const imported=JSON.parse(evt.target.result); if(Array.isArray(imported)){data=imported; render(); saveData(); msg('‚úÖ Daten importiert!');}else{alert('Ung√ºltige Datei!');}}catch(err){alert('Fehler beim Import!');}}; reader.readAsText(file);});

// --- PREVIEW & PDF ---
function previewPDF(pdfData,type){
  previewBody.innerHTML=''; 
  const table=document.createElement('table'); 
  table.className='preview-table';
  const thead=document.createElement('thead'); 
  const trh=document.createElement('tr');
  if(type==='angebot'){
    ['Auswahl','Bild','Nr.','Artikel','Kartons','Stk','Gesamt','Preis'].forEach(h=>{
      const th=document.createElement('th'); 
      th.innerText=h; 
      trh.appendChild(th);
    });
  }else{
    ['Bild','Nr.','Artikel','Kartons','Stk','Gesamt'].forEach(h=>{
      const th=document.createElement('th'); 
      th.innerText=h; 
      trh.appendChild(th);
    });
  }
  thead.appendChild(trh); 
  table.appendChild(thead);
  const tbody=document.createElement('tbody');
  pdfData.forEach((d,i)=>{
    const tr=document.createElement('tr');
    if(type==='angebot'){
      const tdCheck=document.createElement('td'); 
      const chk=document.createElement('input'); 
      chk.type='checkbox'; 
      tdCheck.appendChild(chk); 
      tr.appendChild(tdCheck);
    }
    const tdImg=document.createElement('td'); 
    if(d.image){
      const img=document.createElement('img'); 
      img.src=d.image; 
      img.className='preview-img';
      tdImg.appendChild(img);
    } 
    tr.appendChild(tdImg);
    [d.barcode,d.artikel,d.kartons,d.stueck,d.gesamt].forEach(v=>{
      const td=document.createElement('td'); 
      td.innerText=v; 
      tr.appendChild(td);
    });
    if(type==='angebot'){
      const tdPrice=document.createElement('td'); 
      const inputPrice=document.createElement('input'); 
      inputPrice.type='number'; 
      inputPrice.step='0.01'; 
      inputPrice.style.width='80px'; 
      tdPrice.appendChild(inputPrice); 
      tr.appendChild(tdPrice);
    }
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); 
  previewBody.appendChild(table); 
  previewModal.style.display='block';
  downloadPreviewPdf.onclick=()=>{generatePDF(pdfData,type);}
}

function generatePDF(pdfData,type){
  const { jsPDF } = window.jspdf; 
  const doc=new jsPDF();
  doc.setFontSize(16); 
  doc.text(type==='angebot'?'Angebot':'Bestandsliste',14,20);
  const rows=pdfData.map(d=>{
    if(type==='angebot'){
      return [d.barcode,d.artikel,d.kartons,d.stueck,d.gesamt,d.price||'',d.image||''];
    } else return [d.barcode,d.artikel,d.kartons,d.stueck,d.gesamt,d.image||''];
  });
  doc.autoTable({
    head:type==='angebot'?[['Nr.','Artikel','Kartons','Stk','Gesamt','Preis','Bild']]:[['Nr.','Artikel','Kartons','Stk','Gesamt','Bild']],
    body:rows,
    styles:{cellPadding:3,fontSize:10,halign:'center'},
    headStyles:{fillColor:[76,175,80]},
    theme:'grid'
  });
  doc.save(type==='angebot'?'Angebot.pdf':'Bestandsliste.pdf');
}

// --- BESTANDSLISTE PDF ---
document.getElementById('btnInventory').addEventListener('click',()=>{if(!data.length){alert('Keine Eintr√§ge!'); return;} previewPDF(data,'bestand');});

// --- ANGEBOT ---
document.getElementById('btnOffer').addEventListener('click',()=>{
  if(!data.length){alert('Keine Eintr√§ge!'); return;}
  const offerData=data.map(d=>({...d}));
  previewPDF(offerData,'angebot');
});

render();
</script>
</body>
</html>